# Deploy a preview environment for each pull request.
# Each PR gets its own piku app, database schema, and public URL.

name: Preview Deploy

on:
  pull_request:
    types: [opened, synchronize, reopened]

concurrency:
  group: preview-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    environment:
      name: preview
      url: https://pr-${{ github.event.pull_request.number }}.${{ vars.PREVIEW_DOMAIN }}

    env:
      APP_NAME: voter-api-pr-${{ github.event.pull_request.number }}
      PR_NUM: ${{ github.event.pull_request.number }}
      PIKU: piku@${{ vars.PIKU_HOST }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Install Postgres client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Create preview database schema
        env:
          DATABASE_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
        run: |
          echo "Creating schema: pr_${PR_NUM}"
          psql "${DATABASE_URL}" -c "CREATE SCHEMA IF NOT EXISTS pr_${PR_NUM};"

      - name: Configure SSH for piku
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PIKU_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ vars.PIKU_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Configure preview environment
        env:
          PREVIEW_DATABASE_URL: ${{ secrets.PREVIEW_DATABASE_URL }}
          JWT_SECRET_KEY: ${{ secrets.PREVIEW_JWT_SECRET_KEY }}
        run: |
          # Replace postgresql:// with postgresql+asyncpg:// for the app
          ASYNC_DB_URL="${PREVIEW_DATABASE_URL/postgresql:\/\//postgresql+asyncpg:\/\/}"

          # config:set BEFORE git push â€” piku runs the release worker
          # (Alembic migrations) during deploy, so DATABASE_SCHEMA must
          # already be set or migrations target the public schema.
          ssh ${PIKU} config:set ${APP_NAME} \
            DATABASE_URL="${ASYNC_DB_URL}" \
            DATABASE_SCHEMA="pr_${PR_NUM}" \
            JWT_SECRET_KEY="${JWT_SECRET_KEY}" \
            NGINX_SERVER_NAME="pr-${PR_NUM}.${{ vars.PREVIEW_DOMAIN }}" \
            ELECTION_REFRESH_ENABLED=false \
            CORS_ORIGIN_REGEX=".*" \
            BIND_ADDRESS=0.0.0.0

      - name: Deploy app to piku
        run: |
          git remote add piku "${PIKU}:${APP_NAME}"
          git push piku HEAD:main --force

      - name: Smoke test
        run: |
          URL="https://pr-${PR_NUM}.${{ vars.PREVIEW_DOMAIN }}/api/v1/health"
          echo "Waiting for ${URL}..."
          for i in 1 2 3 4 5; do
            if curl -sf --max-time 10 "${URL}"; then
              echo ""
              echo "Preview is up!"
              exit 0
            fi
            echo "Attempt ${i}/5 failed, retrying in 15s..."
            sleep 15
          done
          echo "Preview did not respond after 5 attempts"
          exit 1

      - name: Comment preview URL on PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-tag: preview-deploy
          body: |
            ### Preview Environment

            | Resource | URL |
            |----------|-----|
            | **API** | https://pr-${{ github.event.pull_request.number }}.${{ vars.PREVIEW_DOMAIN }} |
            | **API Docs** | https://pr-${{ github.event.pull_request.number }}.${{ vars.PREVIEW_DOMAIN }}/docs |

            _Last deployed: `${{ github.sha }}` at ${{ github.event.pull_request.updated_at }}_
